---
title: "Mise en forme et préparation des données"
author: "Thomas Vroylandt"
date: "04/01/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{r packages}
library(tidyverse)
library(magrittr)
library(rvest)
library(lubridate)
library(here)

# Pour transformer les NULL en NA et éviter l'erreur du flatten
null_na <- function(x) {
  ifelse(is.null(x), NA, x)
}
```

## Mise en forme du XML

Les données sont tirées de https://jorfsearch.steinertriples.fr/tag/legion_honneur.

On charge le fichier, qu'on passe ensuite en liste. Différents blocs servent alors à lire les attributs et le contenu, qu'on assemble ensuite. On sauvegarde alors le fichier.

```{r clean_xml, eval = FALSE}
# Import XML
x <-
  read_xml(here("data/legion honneur.xml"))

# En liste
xml_list <- x %>%
  xml_find_all("result") %>%
  map(as_list)

# Lire les attributs du décret
df_attr <- xml_list %>%
  map(attributes) %>%
  map_dfr(flatten_dfc) %>%
  select(-V1,-V2)

# Lire les noms
df_noms <- xml_list %>% 
  map(use_series, person) %>% 
  map(use_series, name) %>% 
  map(attributes) %>% 
  map(lapply, null_na) %>% 
  map(flatten_dfc) %>% 
  map_if(function(x)is_tibble(x) == FALSE,
         function(x)tibble(na = "0000")) %>% 
  bind_rows()

df_noms_text <- xml_list %>% 
  map(use_series, person) %>% 
  map(use_series, name) %>% 
  map(lapply, null_na) %>% 
  map(flatten_dfc) %>% 
  map_if(function(x)is_tibble(x) == FALSE,
         function(x)tibble(na = "0000")) %>% 
  bind_rows()

# Lire les raisons
df_raisons <- xml_list %>% 
  map(use_series, person) %>% 
  map(use_series, text) %>% 
  map(lapply, null_na) %>% 
  map(flatten_dfc) %>% 
  map_if(function(x)is_tibble(x) == FALSE,
         function(x)tibble(na = "0000")) %>% 
  bind_rows()

# Lire le texte
df_text <- xml_list %>% 
  map(use_series, object) %>% 
  map(lapply, null_na) %>% 
  map(flatten_dfc) %>% 
  map_if(function(x)is_tibble(x) == FALSE,
         function(x)tibble(na = "0000")) %>% 
  bind_rows()

# Fusion
df_legion <- df_noms %>%
  bind_cols(df_noms_text) %>% 
  bind_cols(df_raisons) %>%
  bind_cols(df_text) %>%
  bind_cols(df_attr) %>% 
  select(-starts_with("na"))

# Sauvegarde
write_rds(df_legion, here("data/df_legion_init.rds"))
```

## Recodage de la table

La table est importée et filtrée pour enlever :

+ les médaillés militaires inclus à tort ;
+ les médaillés de l'ordre du mérite, idem ;
+ les médaillés de la médaille de reconnaissance aux victimes du terrorisme, idem.

Leur inclusion à tort est due au fait que ces décorations sont gérées par la chancellerie de la Légion d'honneur et que la construction des tags peut les inclure. On fait confiance aux tags complémentaires pour les filtres.

```{r import_filtre}
df_legion_0 <- read_rds(here("data/df_legion_init.rds")) %>% 
  filter(is.na(medaille_militaire) & 
           is.na(ordre_merite) & 
           !str_detect(text, "terrorisme") &
           year(as_date(source_date)) >= 2000)
```

### Statut militaire

On va chercher à déterminer qui sont les militaires. Pour cela on se fonde sur une liste des armes, qu'on cherche ensuite à détecter, de même que l'apparition du mot "militaire" dans la description.

Une fois cela fait, on part du principe que :

+ quand il y a un décret de nomination/promotion pour des militaires, il leur est propre ;
+ il n'y a pas de décret le même jour pour des militaires et des civils.

Cela semble correct au vu des quelques observations.

On va alors mettre en place une règle pour classer toutes les nominations/promotions de ces décrets puis de ces journées comme militaire, à partir du moment où on détecte initialement 50 % de militaires dedans.

Cette procédure peut parfois en laisser de côté ou en inclure à tort, mais elle semble efficace.

```{r ind_militaire}
# liste des armes
l_armees <- c("armee de terre",
              "armée de terre",
              "armee de l'air",
              "armée de l'air",
              "armée de l'air / officier",
              "marine nationale",
              "gendarmerie nationale",       
              "gendarmerie",
              "delegation generale pour l'armement",
              "délégation générale pour l'armement",
              "direction générale de l'armement",
              "service du commissariat des armées",
              "service d'infrastructure de la défense",
              "service de sante des armees",     
              "service de santé des armées",  
              "controle general des armees",
              "contrôle général des armées",
              "service des essences des armees",
              "service des essences des armées",
              "justice militaire",
              "anciens combattants",
              "anciens combattants - résistants")

# verif correspondance texte - liste des armes
df_legion_mili_1 <- df_legion_0 %>% 
  mutate_at(vars(starts_with("text")), str_to_lower) %>% 
  mutate(militaire = case_when(text %in% l_armees ~ "1",
                               text1 %in% l_armees ~ "1",
                               text2 %in% l_armees ~ "1",
                               text3 %in% l_armees ~ "1",
                               text4 %in% l_armees ~ "1",
                               text5 %in% l_armees ~ "1",
                               text6 %in% l_armees ~ "1",
                               text7 %in% l_armees ~ "1",
                               text8 %in% l_armees ~ "1",
                               organization %in% l_armees ~ "1",
                               str_detect(text, "militaire") ~ "1",
                               str_detect(text1, "militaire") ~ "1",
                               str_detect(text2, "militaire") ~ "1",
                               str_detect(text3, "militaire") ~ "1",
                               str_detect(text4, "militaire") ~ "1",
                               str_detect(text5, "militaire") ~ "1",
                               str_detect(text6, "militaire") ~ "1",
                               str_detect(text7, "militaire") ~ "1",
                               str_detect(text8, "militaire") ~ "1",
                               str_detect(organization, "militaire") ~ "1",
                               TRUE ~ "0"))

# tous les ID avec + de 50% de militaire sont considérées militaire, sinon civil
jorf_militaire_id <- df_legion_mili_1 %>%
  group_by(source_id, militaire) %>%
  count() %>%
  pivot_wider(
    names_from = militaire,
    values_from = n,
    values_fill = list(n = 0)
  ) %>%
  mutate(perc = (`1` / (`1` + `0`) * 100)) %>%
  filter(perc >= 50) %>%
  pull(source_id)

df_legion_mili_2 <- df_legion_mili_1 %>% 
  mutate(militaire = if_else(source_id %in% jorf_militaire_id, "1", "0"))

# pareil avec les dates à 50% ou plus
jorf_militaire_date <- df_legion_mili_2 %>% 
  group_by(source_date, militaire) %>% 
  count() %>% 
  pivot_wider(
    names_from = militaire,
    values_from = n,
    values_fill = list(n = 0)
  ) %>%
  mutate(perc = (`1` / (`1` + `0`) * 100)) %>% 
  filter(perc >= 50) %>% 
  pull(source_date)
```

### Grades et date

On cherche ensuite à mettre en forme les dates, ainsi que les grades où quelques corrections minimes sont à faire. On filtre ensuite les colonnes à conserver

```{r date_grades}
df_legion_1 <- df_legion_0 %>%
  rename(nom_complet = V1) %>%
  mutate_at(vars(V11, starts_with("text")), str_to_lower) %>% 
  mutate(
    ind_militaire = if_else(source_date %in% jorf_militaire_date, "1", "0"),
    source_date = as_date(source_date),
    an = year(source_date),
    mois = month(source_date),
    semaine = week(source_date),
    jour = day(source_date),
    mois_jour = paste(mois, jour, sep = "-"),
    grade = fct_collapse(
      grade,
      "Chevalier" = c(
        "Chevalier",
        "Chevalier à titre posthume",
        "Chevalier avec effet du",
        "Chevalier de la Légion d'honneur"
      ),
      "Officier" = c("Officier", "Officier de la Légion d'honneur"),
      "Commandeur" = c("Commandeur",
                       "COMMANDEUR",
                       "Commmandeur"),
      "Grand officier" = "Grand officier",
      "Grand'croix" = c("Grand'croix")
    ),
    grade_precedent = fct_collapse(grade_precedent,
                                   "Chevalier" = c("Chevalier", "Chevalière"))
  ) %>%
  select(
    -corps,
    -magistrat,
    -reference_juridique,
    -birthplace,
    -birthdate,
    -source_name,
    -legion_honneur,
    -medaille_militaire,
    -ordre_merite,
    -text,
    -text4,
    -text5,
    -text6,
    -text7,
    -text8,
    -text9,
    -organization,
    -date1,
    -date2,
    # a conserver par la suite
    -nom,
    -prenom,
    -nom_alternatif,
    -autres_prenoms,
    -mois,
    -semaine,
    -jour
  )
``` 

### Autorité de nomination

On va construire une liste d'autorité de nominations à partir de la détection de mots-clés, qu'on va prendre séquentiellement. Cela correspond globalement aux différents noms des ministères sur la période. Toutefois, les attributions sont parfois mouvantes (travail et solidarités séparés ou ensemble par exemple) et oblige à quelques regroupements en des ensembles plus grands.

```{r nomme_par}
# fonction avec la liste
detect_nomination <- function(x) {
  case_when(
    str_detect(x, "premier ministre|parlement") ~ "premier ministre",
    str_detect(x, "agriculture|agro") ~ "agriculture",
    str_detect(x, "écolo|environnement|ecolo|durable") ~ "environnement",
    str_detect(x, "éducation|enseignement|recherche|éduc") ~ "éducation nationale/enseignement supérieur/recherche",
    str_detect(x, "affaires étrangères|coopération|europ") ~ "affaires étrangères",
    str_detect(
      x,
      "économie|budget|industrie|entreprise|finance|producti|commerce|tourisme|compte"
    ) ~ "économie/budget/industrie",
    str_detect(x, "fonction publique|réforme") ~ "fonction publique",
    str_detect(x, "défense|armée|combattant") ~ "défense/anciens combattants",
    str_detect(x, "culture|communication") ~ "culture",
    str_detect(x, "justice") ~ "justice",
    str_detect(x, "intérieur|immigration") ~ "intérieur/immigration",
    str_detect(x, "travail|emploi|profession") ~ "travail",
    str_detect(
      x,
      "santé|solidarité|famille|femme|égalité|social|exclusion|handicap|âgées|aînés|maladie"
    ) ~ "santé/affaires sociales",
    str_detect(x, "sport|jeunesse|associa") ~ "sport/jeunesse/association",
    str_detect(x, "outre-mer") ~ "outre-mer",
    str_detect(x, "ville|logement|territo|centralisation") ~ "logement/ville/territoires",
    str_detect(x, "équipement|transport") ~ "transports",
    str_detect(x, "chancellerie de la légion d'honneur") ~ "chancellerie de la légion d'honneur"
  )
}

# appliquer
df_legion_2 <- df_legion_1 %>%
  mutate(
    nomme_par = str_to_lower(nomme_par),
    nomme_par_r = detect_nomination(nomme_par),
    nomme_par_r = if_else(
      is.na(nomme_par_r) &
        ind_militaire == "0",
      detect_nomination(text1),
      nomme_par_r
    ),
    nomme_par_r = if_else(
      is.na(nomme_par_r) &
        ind_militaire == "0",
      detect_nomination(text2),
      nomme_par_r
    ),
    nomme_par_r = if_else(
      is.na(nomme_par_r) &
        ind_militaire == "0",
      detect_nomination(text3),
      nomme_par_r
    )
  ) %>%
  select(-nomme_par)
```

### Grades de l'armée et médaille militaire

On classe les grades de l'armée en grandes catégorie et on met une indicatrice si la médaille militaire est indiquée.

```{r armee}
# fonction avec la liste
detect_grade_armee <- function(x) {
  case_when(
    str_detect(
      x,
      "colonel|commandant|capitaine de corvette|capitaine de frégate|capitaine de vaisseau|commandant|escadron|bataillon|médecin|medecin|commissaire|ingénieur|ingenieur|administrat|dentiste|pharmacien|aumônier|aumonier"
    ) ~ "officiers supérieurs",
    str_detect(x, "général|amiral") ~ "officiers généraux",
    str_detect(
      x,
      "soldat|matelot|quartier-maître|quartier maître|quariter-maitre|quartier maitre|caporal|brigadier|garde|chasseur|spahi|artilleur|légionnaire|legionnaire|canonnier|cavalier|cuirassé"
    ) ~ "militaires du rang",
    str_detect(
      x,
      "aspirant|enseigne|lieutenant|capitaine"
    ) ~ "officiers subalternes",
    str_detect(
      x,
      "adjudant|sergent|gendarme|aspirant|major|maître|maitre|maréchal|chef de section"
    ) ~ "sous-officiers"
  )
}


# appliquer
df_legion_3 <- df_legion_2 %>%
  mutate(
    # grade armée
    grade_armee = case_when(ind_militaire == "1" ~ detect_grade_armee(V11)),
    grade_armee = if_else(
      is.na(grade_armee) &
        ind_militaire == "1",
      detect_grade_armee(text1),
      grade_armee
    ),
    grade_armee = if_else(
      is.na(grade_armee) &
        ind_militaire == "1",
      detect_grade_armee(text2),
      grade_armee
    ),
    grade_armee = if_else(
      is.na(grade_armee) &
        ind_militaire == "1",
      detect_grade_armee(text3),
      grade_armee
    ),
    # indicatrice medaille militaire
    ind_medaille_militaire = case_when(
      ind_militaire == "1" ~ str_detect(V11, "militaire|médaill|medaill")
    ),
    ind_medaille_militaire = if_else(
      is.na(ind_medaille_militaire) &
        ind_militaire == "1",
      str_detect(text1, "militaire|médaill|medaill"),
      ind_medaille_militaire
    ),
    ind_medaille_militaire = if_else(
      is.na(ind_medaille_militaire) &
        ind_militaire == "1",
      str_detect(text2, "militaire|médaill|medaill"),
      ind_medaille_militaire
    ),
    ind_medaille_militaire = if_else(
      is.na(ind_medaille_militaire) &
        ind_militaire == "1",
      str_detect(text3, "militaire|médaill|medaill"),
      ind_medaille_militaire
    )
  ) %>%
  select(-text1,-text2,-text3)
```


### Trash

```{r trash, eval = FALSE}

df_legion_3

# extraction dit nom
aa <- df_legion_propre %>% 
  select(V11, annees_service) %>% 
  separate(V11, into = c("a", "b", "c"), sep = ";") %>% 
  mutate_at(vars(a, b, c), str_trim) %>% 
  mutate(dit = str_sub(a, 1, 3) == "dit",
         dit_nom = if_else(dit == TRUE, str_extract(a, "^(.+?),"), ""),
         dit_nom = if_else(dit == TRUE & is.na(dit_nom), a, dit_nom),
         dit_nom = str_remove(dit_nom, ","),
         dit_nom = str_remove(dit_nom, "dit "),
         dit_nom = str_remove(dit_nom, "dite "))
```

## TO DO


+ motif de la nomination (analyse textuelle ?)
+ dit nom à intégrer
+ années de service à vérifier
+ format de la table pour les carrières

En dehors des recodages de variables existantes, l'enjeu consiste à :

+ utiliser le texte libre pour valider et compléter les informations ;
+ recoder ce texte libre pour obtenir les métiers.



